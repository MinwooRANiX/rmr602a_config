<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi 설정</title>
<style>
  body{font-family:system-ui;margin:0;background:#f6f7fb;color:#111}
  .container{max-width:480px;margin:44px auto;padding:22px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{font-size:18px;margin:0 0 12px}

  .row{display:flex;align-items:center;gap:10px;margin-top:12px}
  .cb{width:18px;height:18px}
  label.field{min-width:90px}
  input[type="text"],input[type="password"],input[type="number"]{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}

  /* cluster 비활성화 강조 */
  input[type="number"]:disabled{
    background:#e5e7eb;color:#6b7280;border:1px solid #d1d5db;cursor:not-allowed;
  }

  .actions{display:flex;gap:8px;margin-top:16px}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}

  .adminLine{margin-top:16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .adminLink{background:transparent;border:0;color:#6b7280;cursor:pointer;font-size:12px;padding:0}
  .adminState{font-size:12px;color:#6b7280}
  .adminState.on{color:#065f46;font-weight:800}

  .status{margin-top:14px;display:none}
  .badge{font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px}
  .ok{background:#ecfdf5;color:#065f46}
  .err{background:#fef2f2;color:#991b1b}
  .wait{background:#eff6ff;color:#1d4ed8}

  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;z-index:1000}
  .modalContent{width:320px;background:#fff;border-radius:14px;padding:18px;box-shadow:0 12px 32px rgba(0,0,0,0.2);position:relative}
  .modalTitle{margin:0 0 12px;font-size:15px}
  .modalClose{
    position:absolute;right:10px;top:10px;width:32px;height:32px;border-radius:10px;
    border:1px solid #e5e7eb;background:#fff;color:#111;cursor:pointer;font-size:18px;
    display:flex;align-items:center;justify-content:center;line-height:1;padding:0;
  }
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .modalActions button{
    flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111;font-weight:700;cursor:pointer
  }

  .hint{font-size:12px;color:#6b7280;margin-top:10px;line-height:1.4}
  .hint code{background:#f3f4f6;padding:2px 6px;border-radius:6px}

  /* 숨김 iframe (전송용) */
  iframe{display:none}
</style>
</head>

<body>
<div class="container">
  <h1>Wi-Fi 설정</h1>

  <div class="row">
    <input id="cb_ssid" class="cb" type="checkbox" checked />
    <label class="field">SSID</label>
    <input id="ssid" type="text" placeholder="예: RANIX_WIFI_3F">
  </div>

  <div class="row">
    <input id="cb_pw" class="cb" type="checkbox" checked />
    <label class="field">Password</label>
    <input id="pw" type="password" placeholder="예: 5845516012">
  </div>

  <div class="row">
    <label class="field">Cluster</label>
    <input id="cluster" type="number" min="0" max="2" step="1" inputmode="numeric"
           disabled placeholder="관리자 활성화 필요">
  </div>

  <div class="adminLine">
    <button id="adminBtn" class="adminLink" type="button">고급 설정(관리자)</button>
    <span id="adminState" class="adminState">OFF</span>
  </div>

  <div class="actions">
    <button id="sendBtn">요청 전송</button>
  </div>

  <div id="status" class="status">
    <span id="badge" class="badge wait">대기중</span>
  </div>
  
  <!-- 전송용 (페이지 이동 대신 iframe 네비게이션 사용) -->
  <iframe id="navFrame" title="nav"></iframe>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="modal" role="dialog" aria-modal="true">
  <div class="modalContent">
    <button id="adminX" class="modalClose" type="button" aria-label="닫기">×</button>
    <h3 class="modalTitle">관리자 설정</h3>

    <div class="row" style="margin-top:0">
      <label class="field">Admin PW</label>
      <input id="admin_pw_input" type="password" placeholder="관리자 비밀번호">
    </div>

    <div class="modalActions">
      <button id="adminOff" type="button">관리자 모드 끄기</button>
      <button id="adminOn" type="button">관리자 모드 켜기</button>
    </div>
  </div>
</div>

<script>
  // ESP32 엔드포인트(HTTP)
  const DEVICE_COMMAND = "http://192.168.4.1/command";

  // 관리자 비번
  const ADMIN_PASSWORD = "ranix_admin"; // 필요시 변경

  // 전송 후 GitHub 페이지로 자동 복귀(현재 페이지)
  const RETURN_URL = location.href.split("#")[0];

  const sendBtn = document.getElementById('sendBtn');
  const status = document.getElementById('status');
  const badge = document.getElementById('badge');

  const cbSsid = document.getElementById('cb_ssid');
  const cbPw = document.getElementById('cb_pw');
  const clusterInput = document.getElementById('cluster');

  const adminBtn = document.getElementById('adminBtn');
  const adminStateEl = document.getElementById('adminState');
  const modal = document.getElementById('adminModal');
  const adminPwInput = document.getElementById('admin_pw_input');
  const adminOnBtn = document.getElementById('adminOn');
  const adminOffBtn = document.getElementById('adminOff');
  const adminX = document.getElementById('adminX');

  const navFrame = document.getElementById('navFrame');

  let adminEnabled = false;

  function clampClusterIfNeeded(){
    if(clusterInput.disabled) return;
    const raw = String(clusterInput.value || "").trim();
    if(raw === "") return;

    const n = Number(raw);
    if(!Number.isInteger(n) || n < 0 || n > 2){
      clusterInput.value = "";
      alert("Cluster 값은 0 ~ 2만 가능합니다.");
    }
  }

  clusterInput.addEventListener('change', clampClusterIfNeeded);
  clusterInput.addEventListener('blur', clampClusterIfNeeded);
  clusterInput.addEventListener('input', ()=>{
    const v = clusterInput.value;
    if(v === "") return;
    if(!/^\d+$/.test(v)) clusterInput.value = v.replace(/[^\d]/g,'');
  });

  function setAdminState(on){
    adminEnabled = on;
    if(on){
      adminStateEl.textContent = "ON";
      adminStateEl.className = "adminState on";
      clusterInput.disabled = false;
      clusterInput.placeholder = "0~2";
    }else{
      adminStateEl.textContent = "OFF";
      adminStateEl.className = "adminState";
      clusterInput.disabled = true;
      clusterInput.value = "";
      clusterInput.placeholder = "관리자 활성화 필요";
    }
  }
  setAdminState(false);

  function openModal(){
    modal.style.display = "flex";
    adminPwInput.value = "";
    setTimeout(()=>adminPwInput.focus(), 0);
  }
  function closeModal(){
    modal.style.display = "none";
  }

  adminBtn.addEventListener('click', openModal);
  adminX.addEventListener('click', closeModal);

  document.addEventListener('keydown', function(e){
    if(e.key === "Escape" && modal.style.display === "flex"){
      closeModal();
    }
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal();
  });

  adminPwInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') adminOnBtn.click();
  });

  adminOffBtn.addEventListener('click', ()=>{
    setAdminState(false);
    closeModal();
  });

  adminOnBtn.addEventListener('click', ()=>{
    if(adminPwInput.value === ADMIN_PASSWORD){
      setAdminState(true);
      closeModal();
    }else{
      setAdminState(false);
      alert("관리자 비밀번호가 올바르지 않습니다.");
    }
  });

  function buildCommandUrl(){
    const ssidVal = encodeURIComponent(document.getElementById('ssid').value.trim());
    const pwVal   = encodeURIComponent(document.getElementById('pw').value);

    clampClusterIfNeeded();

    const params = [];
    if(cbSsid.checked) params.push("ssid=" + ssidVal);
    if(cbPw.checked)   params.push("pw=" + pwVal);

    const clusterRaw = String(clusterInput.value || "").trim();
    if(adminEnabled && clusterRaw !== ""){
      params.push("cluster=" + encodeURIComponent(clusterRaw));
    }

    if(params.length === 0) return null; // 전송할 게 없음
    return DEVICE_COMMAND + "?" + params.join("&");
  }

  sendBtn.addEventListener('click', ()=>{
    const url = buildCommandUrl();
    if(!url){
      status.style.display='block';
      badge.className='badge err';
      badge.textContent='전송할 값이 없습니다';
      return;
    }

    // GitHub(HTTPS) -> ESP32(HTTP) fetch는 모바일에서 차단될 수 있으므로,
    // 주소창 입력과 유사한 방식(네비게이션)으로 전송합니다.
    status.style.display='block';
    badge.className='badge wait';
    badge.textContent='전송중...';

    // 1) iframe 네비게이션으로 요청 전송 (페이지 자체는 유지)
    //    ※ 일부 브라우저에서는 iframe의 mixed content도 막을 수 있어,
    //      실패 대비로 window.open fallback을 둡니다.
    try{
      navFrame.src = url;
    }catch(e){
      // ignore
    }

    // 2) 사용자가 체감할 수 있게 상태 표시
    setTimeout(()=>{
      badge.className='badge ok';
      badge.textContent='전송됨 · 재부팅/전환중...';
    }, 300);

    // 3) 몇 초 후 GitHub 페이지로 복귀(재접속 안내)
    setTimeout(()=>{
      location.href = RETURN_URL;
    }, 2500);

    // 4) iframe이 차단될 수 있으므로, 백업으로 새 탭 열기(팝업 차단이면 무시)
    //    (사용자가 “주소창 직접 입력하면 된다”를 이미 확인했기 때문에 가장 확실한 우회)
    setTimeout(()=>{
      try{ window.open(url, "_blank"); } catch(e) {}
    }, 50);
  });
</script>
</body>
</html>

