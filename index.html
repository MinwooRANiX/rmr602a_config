<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>제품 네트워크 설정 (체크박스 포함)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:#f6f7fb;color:#111}
    .container{max-width:560px;margin:44px auto;padding:22px;background:white;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
    h1{font-size:18px;margin:0 0 12px}
    .row-input{display:flex;align-items:center;gap:10px;margin-top:12px}
    .row-input input[type="text"], .row-input input[type="password"]{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
    .cb{width:20px;height:20px;margin-left:2px}
    label.field-label{min-width:110px}
    .hint{font-size:12px;color:#666;margin-top:8px}
    .actions{display:flex;gap:8px;margin-top:16px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    button.alt{background:#10b981}
    .result{margin-top:12px;padding:10px;background:#f3f4f6;border-radius:8px;font-family:monospace;word-break:break-all;display:none}
    .small{font-size:12px;color:#666;margin-top:8px}
    .select-all{display:flex;align-items:center;gap:8px;margin-top:10px}
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>제품 네트워크 / 서버 주소 설정</h1>

    <div class="row-input">
      <input id="cb_ssid" class="cb" type="checkbox" checked />
      <label class="field-label" for="ssid">Wi-Fi SSID</label>
      <input id="ssid" type="text" placeholder="예: RANIX_WIFI_SSID" />
    </div>

    <div class="row-input">
      <input id="cb_pw" class="cb" type="checkbox" checked />
      <label class="field-label" for="pw">Wi-Fi Password</label>
      <input id="pw" type="password" placeholder="예: RANIX_WIFI_PASSWORD" />
    </div>
	
    <div class="row-input">
      <input id="cb_server" class="cb" type="checkbox" checked />
      <label class="field-label" for="server">Server address (full URL)</label>
      <input id="server" type="text" placeholder="예: http://RANIX_SERVER.com" />
    </div>

    <div class="select-all">
      <input id="cb_all" type="checkbox" />
      <label for="cb_all" style="font-size:13px;color:#444">모두 선택 / 해제</label>
      <div class="hint"> (체크된 항목만 전송됩니다.)</div>
    </div>

    <div class="actions">
      <button id="sendBtn">요청 전송</button>
      <button id="buildBtn" class="alt">요청 URL 미리보기</button>
      <button id="copyBtn" style="background:#6b7280">복사</button>
    </div>

    <div class="small">동작: 브라우저에서 GET 요청으로 디바이스(기본: 192.168.4.1)에 접근합니다. 디바이스가 CORS 헤더를 제공하지 않으면 JS로 응답을 읽지 못하므로 브라우저로 이동(리다이렉트)합니다.</div>

    <div id="result" class="result"></div>
  </div>

  <script>
    const cbServer = document.getElementById('cb_server');
    const cbSsid = document.getElementById('cb_ssid');
    const cbPw = document.getElementById('cb_pw');
    const cbAll = document.getElementById('cb_all');

    const serverInput = document.getElementById('server');
    const ssidInput = document.getElementById('ssid');
    const pwInput = document.getElementById('pw');

    const sendBtn = document.getElementById('sendBtn');
    const buildBtn = document.getElementById('buildBtn');
    const copyBtn = document.getElementById('copyBtn');
    const resultBox = document.getElementById('result');

    function urlEncode(v){ return encodeURIComponent(v || ''); }

    function buildDeviceUrl() {
      const base = 'http://192.168.4.1/command';
      const pairs = [];

      // only include param if its checkbox is checked
      if(cbServer.checked){
        pairs.push('server=' + urlEncode(serverInput.value.trim()));
      }
      if(cbSsid.checked){
        pairs.push('ssid=' + urlEncode(ssidInput.value.trim()));
      }
      if(cbPw.checked){
        pairs.push('pw=' + urlEncode(pwInput.value));
      }

      if(pairs.length === 0) return base; // no query params selected
      return base + '?' + pairs.join('&');
    }

    buildBtn.addEventListener('click', () => {
      const u = buildDeviceUrl();
      resultBox.style.display = 'block';
      resultBox.textContent = u;
    });

    copyBtn.addEventListener('click', () => {
      const u = buildDeviceUrl();
      navigator.clipboard.writeText(u).then(() => {
        copyBtn.textContent = '복사됨';
        setTimeout(()=> copyBtn.textContent = '복사', 1200);
      }).catch(()=> alert('복사 실패 — 브라우저 권한 필요'));
    });

    sendBtn.addEventListener('click', async () => {
      // minimal validation: if a field is checked and required empty (server or ssid), warn
      if(cbServer.checked && !serverInput.value.trim()){
        if(!confirm('Server 항목이 체크되어 있으나 값이 비어있습니다. 비어있는 값을 전송하시겠습니까?')) return;
      }
      if(cbSsid.checked && !ssidInput.value.trim()){
        if(!confirm('SSID 항목이 체크되어 있으나 값이 비어있습니다. 비어있는 값을 전송하시겠습니까?')) return;
      }

      const deviceUrl = buildDeviceUrl();

      // 시도 1: fetch (no-cors; 응답 읽을 수 없을 가능성이 높음)
      try {
        await fetch(deviceUrl, { method: 'GET', mode: 'no-cors', cache: 'no-store' });
      } catch (e) {
        console.log('fetch failed or opaque (expected):', e);
      }

      // 시도 2: 브라우저 이동(가장 확실)
      window.location.href = deviceUrl;
    });

    // Select all toggle
    cbAll.addEventListener('change', () => {
      const v = cbAll.checked;
      cbServer.checked = v;
      cbSsid.checked = v;
      cbPw.checked = v;
    });

    // If user edits a single item, unset "all" box to avoid confusion
    [cbServer, cbSsid, cbPw].forEach(cb => {
      cb.addEventListener('change', () => {
        if(!(cbServer.checked && cbSsid.checked && cbPw.checked)) cbAll.checked = false;
      });
    });

    // URL 파라미터로 기본값 채우기 (QR에 ?ssid=...&server=... 포함 가능)
    (function loadFromQuery() {
      const params = new URLSearchParams(location.search);
      if(params.has('server')) { serverInput.value = params.get('server'); cbServer.checked = true; }
      if(params.has('ssid'))   { ssidInput.value   = params.get('ssid');   cbSsid.checked = true; }
      if(params.has('pw'))     { pwInput.value     = params.get('pw');     cbPw.checked = true; }

      // 만약 쿼리에 해당 키가 없으면 체크박스는 기본으로 유지(checked)
      if(cbServer.checked && cbSsid.checked && cbPw.checked) cbAll.checked = true;
    })();
  </script>
</body>
</html>
