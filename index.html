<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi 설정</title>
<style>
  body{font-family:system-ui;margin:0;background:#f6f7fb;color:#111}
  .container{max-width:480px;margin:44px auto;padding:22px;background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{font-size:18px;margin:0 0 12px}
  .row{display:flex;align-items:center;gap:10px;margin-top:12px}
  .cb{width:18px;height:18px}
  label.field{min-width:90px}
  input[type="text"],input[type="password"],input[type="number"]{
    flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box
  }
  input[type="number"]:disabled,
  input[type="text"]:disabled,
  input[type="password"]:disabled{
    background:#e5e7eb;color:#6b7280;border:1px solid #d1d5db;cursor:not-allowed;
  }
  .actions{display:flex;gap:8px;margin-top:16px}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
  .adminLine{margin-top:16px;display:flex;align-items:center;justify-content:space-between}
  .adminLink{background:transparent;border:0;color:#6b7280;cursor:pointer;font-size:12px;padding:0}
  .adminState{font-size:12px;color:#6b7280}
  .adminState.on{color:#065f46;font-weight:800}
  .status{margin-top:14px;display:none}
  .badge{font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;display:inline-block}
  .ok{background:#ecfdf5;color:#065f46}
  .err{background:#fef2f2;color:#991b1b}
  .wait{background:#eff6ff;color:#1d4ed8}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:1000}
  .modalContent{width:340px;background:#fff;border-radius:14px;padding:18px;box-shadow:0 12px 32px rgba(0,0,0,0.2);position:relative}
  .modalTitle{margin:0 0 12px;font-size:15px}
  .modalClose{
    position:absolute;right:10px;top:10px;width:32px;height:32px;border-radius:10px;
    border:1px solid #e5e7eb;background:#fff;color:#111;cursor:pointer;font-size:18px;
    display:flex;align-items:center;justify-content:center;line-height:1;padding:0;
  }
  .pwWrap{display:flex;gap:8px;align-items:center;flex:1}
  .pwWrap input{flex:1}
  .toggleBtn{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111;font-weight:700;cursor:pointer}
  .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .modalActions button{
    flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;color:#111;font-weight:700;cursor:pointer
  }
  .danger{border-color:#fecaca;background:#fff;color:#991b1b}
</style>
</head>

<body>
<div class="container">
  <h1>Wi-Fi 설정</h1>

  <div class="row">
    <input id="cb_ssid" class="cb" type="checkbox" checked />
    <label class="field">SSID</label>
    <input id="ssid" type="text" autocomplete="off" autocapitalize="off" spellcheck="false">
  </div>

  <div class="row">
    <input id="cb_pw" class="cb" type="checkbox" checked />
    <label class="field">Password</label>
    <input id="pw" type="password" autocomplete="off" autocapitalize="off" spellcheck="false">
  </div>

  <div class="row">
    <input id="cb_cluster" class="cb" type="checkbox" />
    <label class="field">Cluster</label>
    <input id="cluster" type="number" min="0" max="2" step="1" inputmode="numeric" disabled>
  </div>

  <div class="adminLine">
    <button id="adminBtn" class="adminLink" type="button">고급 설정(관리자)</button>
    <span id="adminState" class="adminState">OFF</span>
  </div>

  <div class="actions">
    <button id="sendBtn" type="button">요청 전송</button>
  </div>

  <div id="status" class="status">
    <span id="badge" class="badge wait">대기중</span>
  </div>
</div>

<div id="adminModal" class="modal" role="dialog" aria-modal="true">
  <div class="modalContent">
    <button id="adminX" class="modalClose" type="button" aria-label="닫기">×</button>
    <h3 class="modalTitle">관리자 설정</h3>

    <div class="row" style="margin-top:0">
      <label class="field">Mode</label>
      <div style="flex:1;display:flex;gap:10px;align-items:center">
        <label style="display:flex;gap:6px;align-items:center;font-size:13px;color:#111">
          <input id="adminModeOn" type="radio" name="adminMode" value="on"> 켜기
        </label>
        <label style="display:flex;gap:6px;align-items:center;font-size:13px;color:#111">
          <input id="adminModeOff" type="radio" name="adminMode" value="off"> 끄기
        </label>
      </div>
    </div>

    <div class="row">
      <label class="field">Admin PW</label>
      <div class="pwWrap">
        <input id="adminPw" type="password" placeholder="관리자 비밀번호" autocomplete="off">
        <button id="pwToggle" type="button" class="toggleBtn">보기</button>
      </div>
    </div>

    <div class="modalActions">
      <button id="adminCancel" type="button">닫기</button>
      <button id="adminApply" type="button">적용</button>
    </div>
  </div>
</div>

<script>
const DEVICE_COMMAND="http://192.168.4.1/command";
const ADMIN_PASSWORD="12345679";
const LS_KEY="rmr602a_cfg_table_v2";

const cbSsid=document.getElementById("cb_ssid");
const cbPw=document.getElementById("cb_pw");
const cbCluster=document.getElementById("cb_cluster");

const ssid=document.getElementById("ssid");
const pw=document.getElementById("pw");
const cluster=document.getElementById("cluster");

const sendBtn=document.getElementById("sendBtn");
const status=document.getElementById("status");
const badge=document.getElementById("badge");

const adminBtn=document.getElementById("adminBtn");
const adminState=document.getElementById("adminState");

const modal=document.getElementById("adminModal");
const adminX=document.getElementById("adminX");
const adminCancel=document.getElementById("adminCancel");
const adminApply=document.getElementById("adminApply");
const adminPw=document.getElementById("adminPw");
const pwToggle=document.getElementById("pwToggle");
const adminModeOn=document.getElementById("adminModeOn");
const adminModeOff=document.getElementById("adminModeOff");

let adminEnabled=false;

function setBadge(type,text){
  status.style.display="block";
  badge.className="badge "+type;
  badge.textContent=text;
}

function saveState(){
  try{
    localStorage.setItem(LS_KEY,JSON.stringify({
      cbSsid:cbSsid.checked,
      cbPw:cbPw.checked,
      cbCluster:cbCluster.checked,
      ssid:ssid.value,
      pw:pw.value,
      cluster:cluster.value,
      adminEnabled:adminEnabled
    }));
  }catch(e){}
}

function applyClusterEnable(){
  const enable = adminEnabled && cbCluster.checked;
  cluster.disabled = !enable;
  cbCluster.disabled = !adminEnabled;
  if(!adminEnabled){
    cbCluster.checked = false;
    cluster.value = "";
    cluster.disabled = true;
  }else{
    if(!cbCluster.checked){
      cluster.value = "";
      cluster.disabled = true;
    }
  }
}

function updateAdmin(write=true){
  if(adminEnabled){
    adminState.textContent="ON";
    adminState.className="adminState on";
  }else{
    adminState.textContent="OFF";
    adminState.className="adminState";
  }
  applyClusterEnable();
  if(write) saveState();
}

function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(raw){
      const s=JSON.parse(raw);
      cbSsid.checked = (s.cbSsid ?? true);
      cbPw.checked = (s.cbPw ?? true);
      cbCluster.checked = (s.cbCluster ?? false);
      ssid.value = (s.ssid ?? "");
      pw.value = (s.pw ?? "");
      cluster.value = (s.cluster ?? "");
      adminEnabled = (s.adminEnabled ?? false);
    }
  }catch(e){}
  updateAdmin(false);
}

function openModal(){
  modal.style.display="flex";
  adminPw.value="";
  adminPw.type="password";
  pwToggle.textContent="보기";
  if(adminEnabled){
    adminModeOn.checked=true;
  }else{
    adminModeOff.checked=true;
  }
  setTimeout(()=>adminPw.focus(),0);
}

function closeModal(){
  modal.style.display="none";
}

pwToggle.addEventListener("click", ()=>{
  if(adminPw.type==="password"){
    adminPw.type="text";
    pwToggle.textContent="숨기기";
  }else{
    adminPw.type="password";
    pwToggle.textContent="보기";
  }
});

adminBtn.addEventListener("click", openModal);
adminX.addEventListener("click", closeModal);
adminCancel.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modal.style.display==="flex") closeModal(); });

adminApply.addEventListener("click", ()=>{
  const wantOn = adminModeOn.checked;
  const wantOff = adminModeOff.checked;

  if(wantOff){
    adminEnabled=false;
    updateAdmin();
    setBadge("ok","관리자 모드 OFF");
    closeModal();
    return;
  }

  if(wantOn){
    if(adminPw.value === ADMIN_PASSWORD){
      adminEnabled=true;
      updateAdmin();
      setBadge("ok","관리자 모드 ON");
      closeModal();
    }else{
      setBadge("err","비밀번호 오류");
    }
    return;
  }

  setBadge("err","모드를 선택해주세요");
});

cbCluster.addEventListener("change", ()=>{
  applyClusterEnable();
  saveState();
});

function validateCluster(){
  const raw = String(cluster.value || "").trim();
  if(raw === ""){
    setBadge("err","Cluster를 체크했으면 0~2 값을 입력해야 합니다");
    return false;
  }
  if(!/^\d+$/.test(raw)){
    setBadge("err","Cluster는 0~2 숫자만 가능합니다");
    return false;
  }
  const n = Number(raw);
  if(!(n===0 || n===1 || n===2)){
    setBadge("err","Cluster는 0~2만 가능합니다");
    return false;
  }
  cluster.value = String(n);
  return true;
}

cluster.addEventListener("input", ()=>{
  const v = cluster.value;
  if(v === "") { saveState(); return; }
  if(!/^\d+$/.test(v)) cluster.value = v.replace(/[^\d]/g,'');
  saveState();
});
cluster.addEventListener("blur", ()=>{
  if(cbCluster.checked && adminEnabled){
    validateCluster();
  }
  saveState();
});

function buildUrl(){
  const params = [];

  if(cbSsid.checked){
    params.push("ssid=" + encodeURIComponent(ssid.value.trim()));
  }
  if(cbPw.checked){
    params.push("pw=" + encodeURIComponent(pw.value));
  }
  if(cbCluster.checked){
    if(!adminEnabled){
      setBadge("err","Cluster는 관리자 모드에서만 전송할 수 있습니다");
      return null;
    }
    if(!validateCluster()) return null;
    params.push("cluster=" + encodeURIComponent(cluster.value.trim()));
  }

  if(params.length === 0) return null;
  return DEVICE_COMMAND + "?" + params.join("&");
}

sendBtn.addEventListener("click", ()=>{
  saveState();

  if(!cbSsid.checked && !cbPw.checked && !cbCluster.checked){
    setBadge("err","Wi-Fi 정보를 입력해주세요");
    return;
  }

  const url = buildUrl();
  if(!url){
    if(badge.textContent==="대기중") setBadge("err","전송하지 않음");
    return;
  }

  setBadge("wait","전송중...");
  window.open(url,"_blank");
  setTimeout(()=>setBadge("ok","전송 요청 완료"),300);
});

[cbSsid, cbPw, cbCluster, ssid, pw].forEach(el=>{
  ["input","change","blur","keyup"].forEach(e=>el.addEventListener(e,saveState));
});

document.addEventListener("DOMContentLoaded", loadState);
window.addEventListener("pageshow", loadState);
</script>
</body>
</html>
